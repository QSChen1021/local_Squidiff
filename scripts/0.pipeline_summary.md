# 数据处理与训练流水线 - Mast Cell

> Squidiff 项目的完整数据处理与训练流程

## 流程概览

```
1. 数据输出 (R) → 5. 格式转换 (Python) → 2. 数据验证 → 3. 训练模型 → 4. 模型推理
```

---

## 脚本说明

### 1. `1.data_output.r` - 数据输出脚本

**功能**: 从 Seurat 对象提取 Mast Cell 数据并保存为 h5seurat 格式

**输入**:
- Seurat 对象 (`fascia.rds`)
- 包含细胞类型注释 (`cellclusters2`)
- 包含分组信息 (`sample`)

**输出** (保存在 `data/` 目录):
- `mast_cells_200genes.h5seurat` - Seurat 数据文件 (200 基因)
- `mast_cell_top500_markers.csv` - 差异基因列表
- `mast_cell_200_genes.txt` - 200个基因列表
- `mast_cells_200_metadata.csv` - 元数据

**处理步骤**:
1. 筛选 Mast Cell 类型细胞
2. 标准化数据
3. 计算差异基因 (top 500)
4. 进一步筛选为 200 个高变基因
5. 保存为 h5ad 格式

**运行方式**:
```r
# 在 R 中运行
source("scripts/1.data_output.r")
```

**注意**: 此脚本输出 `.h5seurat` 格式，需要下一步转换。

---

### 2. `2.train_mast_cells.sh` - 训练脚本

**功能**: 使用 Mast Cell 数据训练 Squidiff 模型

**输入**:
- `data/mast_cells_200genes.h5ad` (转换后)

**输出**:
- 模型检查点保存在 `logs/mast_cells_<timestamp>/`

**关键参数**:
| 参数 | 值 | 说明 |
|------|-----|------|
| `gene_size` | 200 | 输入基因数 |
| `output_dim` | 200 | 输出维度 |
| `batch_size` | 64 | 批次大小 |
| `lr` | 1e-4 | 学习率 |
| `diffusion_steps` | 1000 | 扩散步数 |

**运行方式**:
```bash
# 在项目根目录运行
bash scripts/2.train_mast_cells.sh
```

---

### 3. `3.sample_mast_cells.py` - 采样/推理脚本

**功能**: 使用训练好的模型进行预测

**输入**:
- 训练好的模型文件
- 测试数据 (`data/mast_cells_200genes.h5ad`)

**输出**:
- `outputs/mast_cells_predicted.h5ad` - 包含预测结果

**运行方式**:
```bash
python scripts/3.sample_mast_cells.py \
  --model_path logs/mast_cells_<timestamp>/model.pt \
  --data_path data/mast_cells_200genes.h5ad \
  --output_dir outputs
```

---

### 5. `5.convert_h5seurat_to_h5ad.py` - 格式转换脚本 (Python)

**功能**: 将 .h5seurat 文件转换为 .h5ad 格式

**输入**:
- `data/mast_cells_200genes.h5seurat`

**输出**:
- `data/mast_cells_200genes.h5ad`

**运行方式**:
```bash
python scripts/5.convert_h5seurat_to_h5ad.py data/mast_cells_200genes.h5seurat
```

### 6. `4.validate_data.py` - 数据验证脚本

**功能**: 验证 h5ad 数据是否符合 Squidiff 要求

**检查项目**:
- 文件存在性
- 细胞数和基因数
- 必需的 metadata 列 (`Group`)
- SMILES 和 dose 列 (使用药物结构时)
- 数据类型和缺失值

**功能**: 验证 h5ad 数据是否符合 Squidiff 要求

**检查项目**:
- 文件存在性
- 细胞数和基因数
- 必需的 metadata 列 (`Group`)
- SMILES 和 dose 列 (使用药物结构时)
- 数据类型和缺失值

**运行方式**:
```bash
python scripts/4.validate_data.py \
  --data_path data/mast_cells_200genes.h5ad
```

---

## 完整流水线

### 步骤 2: 格式转换 (Python)

```bash
# 转换 h5seurat 为 h5ad
python scripts/5.convert_h5seurat_to_h5ad.py data/mast_cells_200genes.h5seurat
```

### 步骤 3: 数据验证

```bash
# 确保在项目根目录
cd E:/Development/Squidiff

# 创建数据目录
mkdir -p data logs outputs
```

在 R 或 RStudio 中运行:
```r
source("scripts/1.data_output.r")
```

### 步骤 4: 训练模型

```bash
python scripts/4.validate_data.py --data_path data/mast_cells_200genes.h5ad
```

### 步骤 5: 模型推理

```bash
bash scripts/2.train_mast_cells.sh
```

### 步骤 4: 模型推理

```bash
# 找到最新的模型文件
MODEL_PATH=$(find logs -name "model.pt" -type f -printf '%T@ %p\n' | sort -n | tail -1 | cut -d' ' -f2-)

python scripts/3.sample_mast_cells.py \
  --model_path "$MODEL_PATH" \
  --data_path data/mast_cells_200genes.h5ad \
  --output_dir outputs
```

---

## 目录结构

```
Squidiff/
├── data/                          # 数据目录
│   ├── mast_cells_200genes.h5seurat   # R 脚本输出 (中间格式)
│   ├── mast_cells_200genes.h5ad        # Python 转换后 (最终格式)
│   ├── mast_cell_top500_markers.csv
│   ├── mast_cell_200_genes.txt
│   └── mast_cells_200_metadata.csv
├── logs/                          # 训练日志
│   └── mast_cells_<timestamp>/
│       ├── model.pt               # 模型检查点
│       └── ...                    # 训练日志
├── outputs/                       # 推理结果
│   └── mast_cells_predicted.h5ad
├── scripts/                       # 脚本目录
│   ├── 0.pipeline_summary.md      # 本文件
│   ├── 1.data_output.r
│   ├── 2.train_mast_cells.sh
│   ├── 3.sample_mast_cells.py
│   ├── 4.validate_data.py
│   └── 5.convert_h5seurat_to_h5ad.py
└── train_squidiff.py              # 主训练脚本
```

---

## 常见问题

### Q1: R 脚本报错 "找不到函数"

**解决**: 确保安装了所有 R 包
```r
install.packages("Seurat")
install.packages("dplyr")
remotes::install_github("mojaveazure/seurat-disk")
```

### Q2: h5ad 文件读取失败

**解决**:
```bash
pip install h5py scanpy
```

### Q3: 训练时 CUDA out of memory

**解决**: 减小 batch_size
```bash
# 编辑 train_mast_cells.sh
BATCH_SIZE=32  # 改为更小的值
```

### Q4: 基因数不匹配

**解决**: 确保 `gene_size` 与实际数据基因数一致
```bash
# 检查实际基因数
python -c "import scanpy as sc; adata = sc.read_h5ad('data/mast_cells_200genes.h5ad'); print(adata.n_vars)"

# 更新训练脚本中的 GENE_SIZE 参数
```

---

## 参数调优建议

### 数据预处理
- **基因数**: 100-500 基因适合快速测试，1000-2000 基因适合完整训练
- **细胞数**: 至少 500 个细胞，建议 1000+ 以获得稳定结果

### 训练参数
- **batch_size**: GPU 内存充足时使用 64-128，内存不足时使用 16-32
- **lr**: 默认 1e-4，训练不稳定时可降低到 5e-5
- **diffusion_steps**: 默认 1000，可尝试 500-2000

### 模型参数
- **num_layers**: 3-5 层
- **num_channels**: 128-2048
- **use_encoder**: 建议设为 TRUE

---

## 性能参考

基于 Mast Cell 数据 (402 细胞, 200 基因):

| 配置 | 训练时间 | GPU 内存 |
|------|----------|----------|
| RTX 3090, batch=64 | ~10 分钟 | ~2 GB |
| RTX 3060, batch=32 | ~20 分钟 | ~4 GB |
| CPU (无 GPU) | ~2 小时 | - |

---

*最后更新: 2025-02-09*
