# Squidiff 部署与运行文档

> 合并说明：本文件已整合原 `部署文档.md` 与 `环境安装指南.md`，作为统一入口。

## 1. 适用范围

- 本文用于本地环境搭建、依赖安装、训练/推理运行与最小化验证。
- Seurat 数据转换请看 `docs/seurat转换指南.md`。
- 排错与快速定位请看 `docs/避坑指南.md`。

## 2. 环境要求

### 2.1 硬件建议

| 组件 | 最低配置 | 推荐配置 |
|---|---|---|
| CPU | 4 核 | 8 核及以上 |
| 内存 | 16 GB | 32 GB 及以上 |
| GPU | GTX 1060 6GB | RTX 3090/4090 24GB |
| 存储 | 50 GB | 100 GB+ SSD |

### 2.2 软件建议

- **Python**: `3.9`, `3.10`, `3.11`（推荐 3.11）
  - ⚠️ **Python 3.13 兼容性**：当前 `scanpy>=1.10.0` 支持 Python 3.9-3.11；Python 3.13 需等待 `scanpy>=1.12.0`（开发中）
- **操作系统**: Windows / Linux / macOS
- **GPU 与 CUDA**: 
  - ⚠️ **必须使用 GPU**：Squidiff 训练需要 GPU，不支持 CPU 训练
  - 必须安装 CUDA 版本的 PyTorch（根据本机 CUDA 版本选择，常见为 CUDA 11.8 或 12.1）
  - 查看 CUDA 版本：`nvidia-smi`
- **包管理器**: 优先推荐 `uv`（速度更快），备选 `pip`
- **国内用户**: 建议配置镜像源加速下载（清华、阿里云等）

## 3. 安装流程

### 3.1 使用 `uv`（推荐，优先）

#### 3.1.1 安装 uv

```bash
pip install uv
```

#### 3.1.2 创建虚拟环境

```bash
# 自动检测并使用系统 Python（推荐）
uv venv

# 或指定 Python 版本（如系统有多个版本）
uv venv --python 3.11
```

#### 3.1.3 激活虚拟环境

```bash
# Windows
.venv\Scripts\activate

# Linux/macOS
source .venv/bin/activate
```

#### 3.1.4 配置国内镜像源（推荐，加速下载）

```bash
# 配置 uv 使用清华镜像（PyPI）
uv pip install --index-url https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt

# 或配置环境变量（永久生效）
# Windows PowerShell
$env:UV_INDEX_URL="https://pypi.tuna.tsinghua.edu.cn/simple"

# Linux/macOS
export UV_INDEX_URL="https://pypi.tuna.tsinghua.edu.cn/simple"
```

#### 3.1.5 安装项目依赖

```bash
# 使用镜像源安装
uv pip install --index-url https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt
uv pip install --index-url https://pypi.tuna.tsinghua.edu.cn/simple -e ".[dev]"
```

#### 3.1.6 安装 PyTorch（CUDA 版本，必须）

⚠️ **重要**：Squidiff 训练需要 GPU，必须安装 CUDA 版本的 PyTorch，不能使用 CPU 版本。

```bash
# 查看 CUDA 版本
nvidia-smi

# CUDA 11.8（推荐，兼容性最好）
uv pip install --index-url https://download.pytorch.org/whl/cu118 torch torchvision torchaudio

# CUDA 12.1（如使用 CUDA 12.x）
uv pip install --index-url https://download.pytorch.org/whl/cu121 torch torchvision torchaudio

# 国内镜像加速 PyTorch（可选，使用清华镜像）
uv pip install -i https://pypi.tuna.tsinghua.edu.cn/simple torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/cu118
```

### 3.2 使用 `pip`（备选方案）

#### 3.2.1 创建虚拟环境

```bash
# Windows
python -m venv .venv
# 或指定版本：py -3.11 -m venv .venv

# Linux/macOS
python3 -m venv .venv
# 或指定版本：python3.11 -m venv .venv
```

#### 3.2.2 激活虚拟环境

```bash
# Windows
.venv\Scripts\activate

# Linux/macOS
source .venv/bin/activate
```

#### 3.2.3 配置国内镜像源（推荐）

```bash
# 临时使用清华镜像
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt

# 或永久配置（推荐）
# Windows: 创建 %APPDATA%\pip\pip.ini
# Linux/macOS: 创建 ~/.pip/pip.conf
# 内容：
[global]
index-url = https://pypi.tuna.tsinghua.edu.cn/simple
[install]
trusted-host = pypi.tuna.tsinghua.edu.cn
```

#### 3.2.4 安装项目依赖

```bash
pip install -r requirements.txt
pip install -e ".[dev]"
```

#### 3.2.5 安装 PyTorch（CUDA 版本，必须）

⚠️ **重要**：必须安装 CUDA 版本的 PyTorch。

```bash
# CUDA 11.8
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118

# CUDA 12.1
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
```

### 3.3 国内镜像源参考

| 镜像源 | PyPI 地址 | 说明 |
|---|---|---|
| 清华大学 | `https://pypi.tuna.tsinghua.edu.cn/simple` | 推荐，速度快 |
| 阿里云 | `https://mirrors.aliyun.com/pypi/simple/` | 备选 |
| 中科大 | `https://pypi.mirrors.ustc.edu.cn/simple/` | 备选 |
| 豆瓣 | `https://pypi.douban.com/simple/` | 备选 |

## 4. 安装验证

### 4.1 验证核心依赖

```bash
python -c "import torch, scanpy, anndata, numpy; print('core ok')"
python -c "from rdkit import Chem; print('rdkit ok')"
```

### 4.2 验证 CUDA 可用性（重要）

```bash
python -c "import torch; print(f'PyTorch version: {torch.__version__}'); print(f'CUDA available: {torch.cuda.is_available()}'); print(f'CUDA version: {torch.version.cuda if torch.cuda.is_available() else \"N/A\"}')"
```

⚠️ **必须确认输出 `CUDA available: True`**，否则无法进行 GPU 训练。

### 4.3 验证代码质量

```bash
python -m ruff check .
```

## 5. 数据准备

### 5.1 最低输入要求

- `adata.X`：表达矩阵
- `adata.obs["Group"]`：分组标签
- 若 `use_drug_structure=True`：必须包含 `SMILES` 与 `dose`

### 5.2 维度一致性

先检查数据维度：

```bash
python scripts/check_shape.py --data_path path/to/train.h5ad
```

将输出的基因数同时用于：
- `--gene_size`
- `--output_dim`

## 6. 训练

### 6.1 基础训练

```bash
python train_squidiff.py \
  --logger_path "./results/baseline" \
  --data_path "path/to/train.h5ad" \
  --resume_checkpoint "./checkpoints/baseline" \
  --gene_size 159 \
  --output_dim 159
```

### 6.2 药物结构训练

```bash
python train_squidiff.py \
  --logger_path "./results/drug" \
  --data_path "path/to/train.h5ad" \
  --control_data_path "path/to/control.h5ad" \
  --resume_checkpoint "./checkpoints/drug" \
  --use_drug_structure True \
  --gene_size 159 \
  --output_dim 159
```

## 7. 推理

```python
import torch
import scanpy as sc
import sample_squidiff

sampler = sample_squidiff.sampler(
    model_path="checkpoints/baseline/model.pt",
    gene_size=159,
    output_dim=159,
    use_drug_structure=False,
)

adata = sc.read_h5ad("path/to/test.h5ad")
z_sem = sampler.model.encoder(torch.tensor(adata.X).to("cuda"))
pred = sampler.pred(z_sem, gene_size=adata.shape[1])
```

## 8. 常见运维问题

### 8.1 `CUDA out of memory`

- 降低 `--batch_size`
- 降低 `--gene_size`
- 启用 `--use_fp16 True`

### 8.2 维度不匹配 (`mat1 and mat2 shapes cannot be multiplied`)

- 检查 `adata.n_vars`
- 重新对齐 `--gene_size` 与 `--output_dim`

### 8.3 RDKit 安装失败

- 优先使用镜像源：`uv pip install --index-url https://pypi.tuna.tsinghua.edu.cn/simple rdkit`
- 或使用 pip：`pip install -i https://pypi.tuna.tsinghua.edu.cn/simple rdkit`
- 备选：`conda install -c conda-forge rdkit`

### 8.4 网络连接问题（国内用户）

- 优先使用国内镜像源（见 3.3 节）
- 如 PyTorch 下载慢，可使用清华镜像的 PyTorch 源
- 如仍有问题，考虑使用代理或 VPN

## 9. 推荐实践

- 每次训练保存参数快照（JSON）
- 固定依赖版本后再做批量实验
- 先跑小样本验证，再上全量训练
